# Ruby
# Package your Ruby project.
# Add steps that install rails, analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/ruby

trigger:
  batch: true
  branches:
    include:
      - master
      - develop
pr:
  autoCancel: true
  branches:
    include:
      - master
      - develop
      - feature/*

pool:
  vmImage: 'Ubuntu-16.04'

steps:
- task: UseRubyVersion@0
  inputs:
    versionSpec: '>= 2.5'

- script: |
    export ENABLE_COVERAGE=true
    export DB_USERNAME=postgres
    export DB_PORT=5433
    S3_PORT=9000
    CC_TEST_REPORTER=935a4195bd35a993666acc398a01a53daf4e7f11635e90a51c8f30b44cbe1ec9
    sudo apt-get install libpq-dev mcrypt libmcrypt-dev
    chmod +x ./bin/wait-for-it.sh
    sudo rm /usr/local/bin/docker-compose
    curl -L https://github.com/docker/compose/releases/download/1.21.0/docker-compose-Linux-x86_64 > docker-compose
    chmod +x docker-compose
    sudo mv docker-compose /usr/local/bin
    curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter && chmod +x ./cc-test-reporter
    sudo apt-get install pdftk
    gem install bundler -v 1.16.4
  displayName: 'before install'

- script: |
    export ENABLE_COVERAGE=true
    export DB_USERNAME=postgres
    export DB_PORT=5433
    S3_PORT=9000
    CC_TEST_REPORTER=935a4195bd35a993666acc398a01a53daf4e7f11635e90a51c8f30b44cbe1ec9
    ./bin/dev/docker-support-services up -d
    ./bin/wait-for-it.sh localhost:5433
    sleep 5
    ./bin/wait-for-it.sh localhost:5433
    ./bin/wait-for-it.sh localhost:9000
    RAILS_ENV=test bundle install && bundle exec rails db:create db:migrate
    curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
    chmod +x ./cc-test-reporter
    ./cc-test-reporter before-build
  displayName: 'before script'

- script: |
    export ENABLE_COVERAGE=true
    export DB_USERNAME=postgres
    export DB_PORT=5433
    S3_PORT=9000
    CC_TEST_REPORTER=935a4195bd35a993666acc398a01a53daf4e7f11635e90a51c8f30b44cbe1ec9
    RAILS_ENV=test bundle exec rspec
    RAILS_ENV=test cd vendor/gems/et_acas_api; BUNDLE_GEMFILE=$PWD/Gemfile bundle install; BUNDLE_GEMFILE=$PWD/Gemfile bundle exec rake db:create db:migrate; BUNDLE_GEMFILE=$PWD/Gemfile bundle exec rspec
    RAILS_ENV=test bundle exec codeclimate-test-reporter
    curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
    chmod +x ./cc-test-reporter
    # ./cc-test-reporter after-build --exit-code 0
  displayName: 'script'

# - script: bundle exec rake
#   displayName: 'bundle exec rake'
